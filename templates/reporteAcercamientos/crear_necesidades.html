{% extends 'base.html' %}

{% block content %}
  <h2 class="text-center">PRE-IDENTIFICACIÓN DE NECESIDADES DE COOPERACIÓN INTERNACIONAL</h2>

  <form method="POST">
    {% csrf_token %}

    <!-- Checkbox para necesidad identificada -->
    <p>¿Su dependencia ha identificado alguna necesidad de apoyo de la cooperación 
      internacional en el período {{reporte.periodo}}? </p>

    <div class="form-check mb-3">  
      <label for="necesidad_identificado">Si</label>
        <input type="checkbox" id="necesidad_identificado" name="necesidad_identificado" 
             {% if form.necesidad_identificado.value %} checked {% endif %}
             onclick="toggleFields()">
    </div>

    <!-- Campo de texto para necesidades identificadas -->
    <div class="form-group">
      <label for="{{ form.necesidades_identificadas.id_for_label }}">Mencione necesidades identificadas por su dependencia como acciones para
        las cuales busca apoyo por parte de entidades de Cooperación Internacional.</label>
      {{ form.necesidades_identificadas }}
      <!-- Contador de palabras para necesidades identificadas -->
      <small id="wordCountIdentificadas" class="form-text text-muted">0/50 palabras</small>
    </div>

    <!-- Checkbox para cooperante identificado -->
    <p>¿Su dependencia ha identificado un posible cooperante para apoyar estas necesidades?</p>
    <div class="form-check mb-3">
      <label for="cooperante_identificado">Si</label>
      <input type="checkbox" id="cooperante_identificado" name="cooperante_identificado" 
             {% if form.cooperante_identificado.value %} checked {% endif %}
             onclick="toggleFields()">
    </div>

    <!-- Campo de texto para cooperante -->
    <div class="form-group mb-3">
      <label for="{{ form.cooperante.id_for_label }}">Cuál/es:</label>
      {{ form.cooperante }}
      <!-- Contador de palabras para cooperante -->
      <small id="wordCountCooperante" class="form-text text-muted">0/15 palabras</small>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'accounts:listar_reportes' %}" class="btn btn-danger">Salir</a>
    </div>
  </form>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  function toggleFields() {
    var necesidadIdentificado = document.getElementById('necesidad_identificado').checked;
    var cooperanteIdentificado = document.getElementById('cooperante_identificado').checked;

    var necesidadesIdentificadasField = document.getElementById('id_necesidades_identificadas');
    var cooperanteField = document.getElementById('id_cooperante');

    necesidadesIdentificadasField.disabled = !necesidadIdentificado;
    cooperanteField.disabled = !cooperanteIdentificado;

    if (!necesidadIdentificado) {
      necesidadesIdentificadasField.value = '';
    }
    if (!cooperanteIdentificado) {
      cooperanteField.value = '';
    }

    necesidadesIdentificadasField.required = necesidadIdentificado;
    cooperanteField.required = cooperanteIdentificado;
  }

  function countWords(text) {
    var words = text.trim().split(/\s+/);  // Dividir el texto por espacios
    return words.filter(function(word) { return word.length > 0; }).length;  // Contar las palabras no vacías
  }

  function updateWordCount(fieldId, countId, maxWords) {
    var textField = document.getElementById(fieldId);
    var wordCountDisplay = document.getElementById(countId);
    
    var currentText = textField.value;
    var wordCount = countWords(currentText);

    wordCountDisplay.textContent = wordCount + '/' + maxWords + ' palabras';

    // Limitar la cantidad de palabras
    if (wordCount > maxWords) {
      var trimmedText = currentText.split(/\s+/).slice(0, maxWords).join(' ');
      textField.value = trimmedText;
      wordCountDisplay.textContent = maxWords + '/' + maxWords + ' palabras';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    toggleFields();  // Ejecutar la función al cargar la página

    var necesidadesField = document.getElementById('id_necesidades_identificadas');
    var cooperanteField = document.getElementById('id_cooperante');

    necesidadesField.addEventListener('input', function() {
      updateWordCount('id_necesidades_identificadas', 'wordCountIdentificadas', 50);
    });

    cooperanteField.addEventListener('input', function() {
      updateWordCount('id_cooperante', 'wordCountCooperante', 15);
    });
  });
</script>
{% endblock %}
