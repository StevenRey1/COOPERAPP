{% extends 'base.html' %}

{% block content %}

<div class="container mt-4">

  <div class="form-container"> 
  <h5 class="text-center mb-4 form-title">PRE-IDENTIFICACIÓN DE NECESIDADES DE COOPERACIÓN INTERNACIONAL</h5>

  <form method="POST">
    {% csrf_token %}

    <!-- Checkbox para necesidad identificada -->
    <p>¿Su dependencia ha identificado alguna necesidad de apoyo de la cooperación 
      internacional en el período {{reporte.periodo}}? </p>

    <div class="form-check mb-3">  
      <label for="necesidad_identificado">Si</label>
        <input type="checkbox" id="necesidad_identificado" name="necesidad_identificado" 
             {% if form.necesidad_identificado.value %} checked {% endif %}
             onclick="toggleFields()">
    </div>

    <!-- Campo de texto para necesidades identificadas -->
    <div class="form-group">
      <label for="{{ form.necesidades_identificadas.id_for_label }}">Mencione necesidades identificadas por su dependencia como acciones para
        las cuales busca apoyo por parte de entidades de Cooperación Internacional.</label>
      {{ form.necesidades_identificadas }}
      <div class = "invalid-feedback">El máximo de palabras son 50</div>
      <!-- Contador de palabras para necesidades identificadas -->
      <small id="wordCountIdentificadas" class="form-text text-muted">0/50 palabras</small>
    </div>

    <!-- Checkbox para cooperante identificado -->
    <p>¿Su dependencia ha identificado un posible cooperante para apoyar estas necesidades?</p>
    <div class="form-check mb-3">
      <label for="cooperante_identificado">Si</label>
      <input type="checkbox" id="cooperante_identificado" name="cooperante_identificado" 
             {% if form.cooperante_identificado.value %} checked {% endif %}
             onclick="toggleFields()">
    </div>

    <!-- Campo de texto para cooperante -->
    <div class="form-group mb-3">
      <label for="{{ form.cooperante.id_for_label }}">Cuál/es:</label>
      {{ form.cooperante }}
      <div class="invalid-feedback">El máximo de palabras son 15</div>
      <!-- Contador de palabras para cooperante -->
      <small id="wordCountCooperante" class="form-text text-muted">0/15 palabras</small>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'reporteAcercamientos:editar_reporte'  reporte_id=object.reporte.id %}" class="btn btn-danger">Volver</a>
    </div>
  </form>
</div>
</div>

<style>
  body {
      background-color: #e8f5e9;
  }
  .form-container {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  .form-title {
      background-color: #f0f4c3;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  function toggleFields() {
    var necesidadIdentificado = document.getElementById('necesidad_identificado').checked;
    var cooperanteIdentificado = document.getElementById('cooperante_identificado').checked;

    var necesidadesIdentificadasField = document.getElementById('id_necesidades_identificadas');
    var cooperanteField = document.getElementById('id_cooperante');

    necesidadesIdentificadasField.disabled = !necesidadIdentificado;
    cooperanteField.disabled = !cooperanteIdentificado;

    if (!necesidadIdentificado) {
      necesidadesIdentificadasField.value = '';
    }
    if (!cooperanteIdentificado) {
      cooperanteField.value = '';
    }

    necesidadesIdentificadasField.required = necesidadIdentificado;
    cooperanteField.required = cooperanteIdentificado;
  }

  function countWords(text) {
    var words = text.trim().split(/\s+/);  // Dividir el texto por espacios
    return words.filter(function(word) { return word.length > 0; }).length;  // Contar las palabras no vacías
  }

  function updateWordCount(fieldId, countId, maxWords) {
    var textField = document.getElementById(fieldId);
    var wordCountDisplay = document.getElementById(countId);
    
    var currentText = textField.value;
    var wordCount = countWords(currentText);

    wordCountDisplay.textContent = wordCount + '/' + maxWords + ' palabras';

    // Limitar la cantidad de palabras
    if (wordCount > maxWords) {
      textField.classList.add('is-invalid');
    }else{
      textField.classList.remove('is-invalid');
    }
    validateForm();
  }

  document.addEventListener('DOMContentLoaded', function() {
    toggleFields();  // Ejecutar la función al cargar la página

    var necesidadesField = document.getElementById('id_necesidades_identificadas');
    var cooperanteField = document.getElementById('id_cooperante');

    necesidadesField.addEventListener('input', function() {
      updateWordCount('id_necesidades_identificadas', 'wordCountIdentificadas', 50);
    });

    cooperanteField.addEventListener('input', function() {
      updateWordCount('id_cooperante', 'wordCountCooperante', 15);
    });
  });



  // si hay clases is-invalid en el formulario se deshabilita el boton de guardar
  const submitButton = document.querySelector('button[type="submit"]');
  // crear funcion que valide si hay clases is-invalid en el formulario
  function validateForm() {
    const invalidFields = document.querySelectorAll('.is-invalid');
    if (invalidFields.length > 0) {
      submitButton.disabled = true;
    } else {
      submitButton.disabled = false;
    }
  }
</script>
{% endblock %}
