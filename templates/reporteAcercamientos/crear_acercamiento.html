{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Acercamientos de Cooperación Internacional</h2>
    <p>¿Ha realizado algún tipo de acercamiento con alguna entidad de cooperación internacional en este periodo {{reporte.periodo}}?</p>

    <!-- Radio buttons para 'Sí' y 'No' -->
    <div class="d-flex mb-4">
        <div class="form-check me-3">
            <input class="form-check-input" type="radio" id="si" name="acercamiento" value="si" onclick="toggleForm(true)">
            <label class="form-check-label" for="si">Sí</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" id="no" name="acercamiento" value="no" onclick="toggleForm(false)" checked>
            <label class="form-check-label" for="no">No</label>
        </div>
    </div>

    <!-- El formulario, inicialmente oculto si se selecciona 'No' -->
    <form method="POST" id="acercamientoForm" style="display: none;">
        {% csrf_token %}
        <div class="card">
            <div class="card-body">
                <fieldset id="acercamientoFormContainer">
                    <div class="acercamiento-form mb-3">
                        <div class="form-group">
                            <label for="id_entidad_1">Mencione aquí el nombre de la entidad con quien ha realizado los acercamientos</label>
                            <input type="text" name="entidad" id="id_entidad_1" class="form-control" placeholder="Texto máximo 20 palabras" required oninput="countWords('id_entidad_1', 20, 'entidadCount_1')">
                            <small id="entidadCount_1" class="form-text text-muted">0/20 palabras</small>
                        </div>
                        <div class="form-group mt-3">
                            <label for="id_temas_perspectivas_1">Mencione aquí los temas y perspectivas de trabajo colaborativo:</label>
                            <textarea name="temas_perspectivas" id="id_temas_perspectivas_1" class="form-control" placeholder="Texto máximo 100 palabras" required oninput="countWords('id_temas_perspectivas_1', 100, 'temasCount_1')"></textarea>
                            <small id="temasCount_1" class="form-text text-muted">0/100 palabras</small>
                        </div>
                    </div>
                </fieldset>

                <fieldset id="fieldAddForm" style="display: none;">
                    <div class="mt-4">
                        <span>¿Tiene otro acercamiento?</span>
                        <button type="button" class="btn btn-warning" onclick="addForm()">Sí</button>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <a href="{% url 'accounts:listar_reportes' %}" class="btn btn-danger">Salir</a>
                    </div>
                </fieldset>
            </div>
        </div>
    </form>

    <fieldset id="continuar_sin_guardar" style="display: block;" class="mt-4">
        <a href="{% url 'reporteAcercamientos:saltar_acercamiento' reporte.id %}" class="btn btn-primary">Continuar</a>
    </fieldset>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  let formCount = 1;  // Contador para formularios

  function toggleForm(show) {
    const formFieldset = document.getElementById('acercamientoForm');
    const continueField = document.getElementById('continuar_sin_guardar');
    const addField = document.getElementById('fieldAddForm');
    
    if (show) {
      formFieldset.style.display = 'block';  // Muestra el formulario si se selecciona 'Sí'
      addField.style.display = 'block';
      continueField.style.display = 'none';
    } else {
      formFieldset.style.display = 'none';  // Oculta el formulario si se selecciona 'No'
      addField.style.display = 'none';
      continueField.style.display = 'block';
    }
  }

  function addForm() {
    formCount++;
    const formContainer = document.getElementById('acercamientoFormContainer');

    // Clonar el formulario existente
    const newForm = document.querySelector('.acercamiento-form').cloneNode(true);
    
    // Actualizar IDs y nombres de campos para el nuevo formulario
    const newFormHTML = newForm.innerHTML
      .replace(/id_entidad_1/g, `id_entidad_${formCount}`)
      .replace(/id_temas_perspectivas_1/g, `id_temas_perspectivas_${formCount}`)
      .replace(/entidadCount_1/g, `entidadCount_${formCount}`)
      .replace(/temasCount_1/g, `temasCount_${formCount}`);
    
    newForm.innerHTML = newFormHTML;

    // Agregar el botón de eliminar al nuevo formulario
    const deleteButton = document.createElement('button');
    deleteButton.type = 'button';
    deleteButton.className = 'btn btn-danger mt-2';
    deleteButton.textContent = 'Eliminar';
    deleteButton.onclick = () => removeForm(newForm);

    newForm.appendChild(deleteButton);
    
    // Añadir el nuevo formulario al contenedor
    formContainer.appendChild(newForm);
  }

  function removeForm(form) {
    const formContainer = document.getElementById('acercamientoFormContainer');
    if (formContainer.children.length > 1) { // Asegura que siempre quede al menos un formulario
      form.remove();
    }
  }

  // Función para contar palabras
  function countWords(fieldId, maxWords, counterId) {
    const field = document.getElementById(fieldId);
    const wordCount = field.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById(counterId).textContent = `${wordCount}/${maxWords} palabras`;

    // Deshabilita el botón de envío si se excede el número máximo de palabras
    field.setCustomValidity(wordCount > maxWords ? 'Has excedido el límite de palabras.' : '');
  }

  // Inicializar el estado del formulario
  document.getElementById('no').checked ? toggleForm(false) : toggleForm(true);
</script>
{% endblock %}
