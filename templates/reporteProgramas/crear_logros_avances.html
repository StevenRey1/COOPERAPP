{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h2 class="text-center mb-4">RESULTADOS, LOGROS Y/O AVANCES Y ADJUNTOS</h2>

  <form method="POST" enctype="multipart/form-data" id="logrosForm">
    {% csrf_token %}

    <!-- Tabla de Logros -->
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th scope="col">Resultados/Productos Esperados</th>
            <th scope="col">Logros y/o avances</th>
            <th scope="col">Departamentos</th>
            <th scope="col">Municipios</th>
            <th scope="col">Adjuntos</th>
          </tr>
        </thead>
        <tbody>
          
          {{ formset_logro.management_form }}
          {% for form in formset_logro %}
          <tr>
            <td>
              {{form.resultado}}
            </td>
            <td>{{ form.logros_avances_texto }}</td>
            <td>{{ form.departamento }}</td>
            <td>{{ form.municipio }}</td>
            <td>{{ form.adjunto }}</td>
          </tr>
          {% endfor %}
          
        </tbody>
      </table>
    </div>

    <!-- Campos de LogrosAvances -->
    <div class="container">
      <div class="row mb-3">
        <label for="{{ form_logros_avances.logros_significativos.id_for_label }}" class="form-label">Algún aspecto a resaltar como un logro significativo en este periodo:</label>
        <div class="col-12">
          {{ form_logros_avances.logros_significativos }}
          <small class="text-muted" id="count_logros_significativos">0 palabras</small>
          <div class="invalid-feedback">El texto no puede superar las 50 palabras.</div>
        </div>
      </div>

      <div class="row mb-3">
        <label for="{{ form_logros_avances.dificultades.id_for_label }}" class="form-label">Comente en caso haya habido inconvenientes o dificultades presentadas en relación a este proyecto:</label>
        <div class="col-12">
          {{ form_logros_avances.dificultades }}
          <small class="text-muted" id="count_dificultades">0 palabras</small>
          <div class="invalid-feedback">El texto no puede superar las 50 palabras.</div>
        </div>
      </div>

      <div class="row mb-3">
        <p class="form-label">¿Se ha presentado alguna situación que ponga en riesgo el buen relacionamiento con el cooperante?</p>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="riesgo_relacionamiento" value="Sí" id="riesgo_si">
            <label class="form-check-label" for="riesgo_si">Sí</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="riesgo_relacionamiento" value="No" id="riesgo_no" checked>
            <label class="form-check-label" for="riesgo_no">No</label>
          </div>
        </div>
      </div>

      <div class="row mb-3" id="id_detalle_riesgo" style="display: none;">
        <label for="{{ form_logros_avances.detalle_riesgo.id_for_label }}" class="form-label">Explique detalladamente:</label>
        <div class="col-12">
          {{ form_logros_avances.detalle_riesgo}}
          <small class="text-muted" id="count_detalle_riesgo">0 palabras</small>
          <div class="invalid-feedback">El texto no puede superar las 50 palabras.</div>
        </div>
      </div>

      <div class="row mb-3">
        <label for="{{ form_logros_avances.observaciones_generales.id_for_label }}" class="form-label">Observaciones o comentarios generales: otros aspectos respecto al desarrollo de este proyecto (sugerencias, inquietudes etc.):</label>
        <div class="col-12">
          {{ form_logros_avances.observaciones_generales }}
          <small class="text-muted" id="count_observaciones_generales">0 palabras</small>
          <div class="invalid-feedback">El texto no puede superar las 50 palabras.</div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Guardar</button>
      <a href="{% url 'accounts:listar_reportes' %}" class="btn btn-danger">Salir</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  // Mostrar/ocultar el campo "Detalle situación de riesgo"
  const riesgoRelacionamientoField = document.querySelectorAll('input[name="riesgo_relacionamiento"]');
  const detalleRiesgoField = document.getElementById('id_detalle_riesgo');

  riesgoRelacionamientoField.forEach(radio => {
    radio.addEventListener('change', () => {
      detalleRiesgoField.style.display = document.querySelector('input[name="riesgo_relacionamiento"]:checked').value === "Sí" ? 'block' : 'none';
    });
  });

  // Contadores de palabras y validación
const textareas = document.querySelectorAll('textarea[id="id_logros_significativos"], textarea[id="id_dificultades"], textarea[id="id_detalle_riesgo"], textarea[id="id_observaciones_generales"]');
const MAX_WORDS = 50;

textareas.forEach(textarea => {
  const countId = `count_${textarea.id.replace('id_', '').replace('-', '_')}`;
  const countElement = document.getElementById(countId);

  function updateWordCount() {
    const words = textarea.value.trim().split(/\s+/).length;
    countElement.textContent = `${words-1} palabra${words !== 1 ? 's' : ''}`;

    if (words > MAX_WORDS) {
      textarea.classList.add('is-invalid');
      countElement.classList.add('text-danger');
    } else {
      textarea.classList.remove('is-invalid');
      countElement.classList.remove('text-danger');
    }
  }

  textarea.addEventListener('input', updateWordCount);
  updateWordCount(); // Invocar al inicio para mostrar el conteo inicial
});


  // Filtrar municipios al seleccionar departamento
const departamentoSelects = document.querySelectorAll('[id^="id_form-"][id$="-departamento"]');
const municipioSelects = document.querySelectorAll('[id^="id_form-"][id$="-municipio"]');

departamentoSelects.forEach((departamentoSelect, index) => {
  departamentoSelect.addEventListener('change', function() {
    const departamentoId = this.value;
    const municipioSelect = municipioSelects[index];

    // Habilitar el campo de municipio
    municipioSelect.disabled = false;

    // Generar la URL usando el ID del departamento
    const url = `{% url 'reporteProgramas:get_municipios' 0 %}`.replace('0', departamentoId);

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log(data);
        // Limpiar municipios actuales
        municipioSelect.innerHTML = '';

        // Agregar opciones de municipios
        data.municipios.forEach(municipio => {
          const option = document.createElement('option');
          option.value = municipio.id;
          option.textContent = municipio.nombre;
          municipioSelect.appendChild(option);
        });
      })
      .catch(error => console.error('Error:', error));
  });

  });
</script>
{% endblock %}
